<!-- Student takeaway -->
<!-- By the end of this lesson, the student should know:
- That AJAX is used to get data without having to refresh the page
- How to write an AJAX request using jQuery's $.ajax() method
- How to troubleshoot common API errors (e.g. JSONP, disabling CORS, using a proxy)
- That a proxy is an intermediary between a browser and a server
- That JSON data can be accessed and manipulated like a regular JavaScript object
-->

# Accessing API data with AJAX

## AJAX

So far we've figured out how to get data from an API by visiting URLs in our browser, but what if we want to work with the data inside our own website or app?

This is where we'll use _AJAX_ (Asynchronous JavaScript and XML) because it allows us to send and receive data _asynchronously_ (i.e. without having to refresh the page). 

> AJAX got its name a long time ago, when XML was the expected response format. Today, JSON is more common as a response format, but the name remains.

AJAX is used all over the web to help provide continuous user experiences. Twitter uses AJAX to implement the infinite scroll (i.e. it loads more tweets when you get to the bottom of the page). Google uses AJAX to auto-complete search suggestions, and Facebook uses AJAX to instantly show new comments on a post.

## AJAX and APIs

We can also use AJAX to asynchronously request data from an API in our own apps. Our JavaScript can "talk" to an external server, get some data, and update the current page without a browser refresh.

Take a look at the [app](https://hychalknotes.s3.amazonaws.com/weather-app-answer.html) we'll be building to see this in action.  Our weather app requests data from the Wunderground API and displays it on the page in our desired format.

## `$.ajax` with jQuery
There are many ways to perform AJAX requests but they do have some cross-browser quirks, so we'll work with jQuery's `$.ajax()` method to handle our requests. 

[Looking at the documentation](https://api.jquery.com/jQuery.ajax/), the `$.ajax()` method requires us to specify the URL we're requesting from and to provide an optional settings object. The documentation also states that you can pass the URL as **part of** the settings object, but we'll do them separately for clarity.

The `$.ajax` gets the information we're requesting. Once we have it in the browser ([check the 'Network' tab]()), we need to tell the browser what to do with that information. We can chain a `.then()` method onto our `$.ajax()` method like this: `$.ajax().then()` : this tells the browser what to do with the information from the AJAX request when it is returned. 

Let's try this with the TTC API. 

`https://myttc.ca/finch_station.json` becomes:

```js
$.ajax('https://myttc.ca/finch_station.json',{
  method: 'GET',
  dataType: 'json'
}).then(function() {
  console.log('It worked!');
});
```

Open up [the starter files for your first AJAX request](https://hychalknotes.s3.amazonaws.com/my-first-ajax-request.zip) to see this AJAX request in action.

### Oh no! An error!
The result in the console should be an error:

`Cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at https://myttc.ca/finch_station.json. (Reason: CORS header â€˜Access-Control-Allow-Originâ€™ missing).[Learn More]`

Click the `Learn More` link and you'll be redirected to [the MDN docs](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors/CORSMissingAllowOrigin)telling you that a _CORS_ (cross-origin resource sharing) header is missing. 

When we make an HTTP request to a different domain than the one that hosts the file with the request in it, we are creating a _cross-site_ HTTP request. HTTP requests come with information for the browsers called _headers_. Think of headers like the front of a letter: they say who the message is from, who it's to, and where the addressee expected to be located. Most servers will not allow HTTP requests from external sources for security reasons. Kind of like how government officials don't open letters with no return addresses. [Could be anthrax](https://en.wikipedia.org/wiki/2001_anthrax_attacks)!

AJAX is restricted by the _same-origin policy_ which [basically states](https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy) that people can only send letters to themselves (i.e. AJAX requests to a domain/subdomain can only come from that same domain/subdomain). 

#### How do we send letters to other people!?
##### JSONP
One way of getting around the same-origin policy without messing directly with the headers is to ask for a data format called _JSON with padding_ (JSONP) in your AJAX request. The **padding** is a JavaScript wrapper that the server has set up (not all APIs have this wrapper set up, but many do. If your API doesn't, there are [other ways to ask for the data]()). 

When we request JSONP in our `$.ajax()` method, jQuery injects a script tag into our website temporarily. The script's `src` attribute points to a bit of JavaScript on the server from which we requested data. The server then wraps the JSON data in a JavaScript function (the aforementioned padding). This function becomes available to us, gets executed, and we get our data. Then, the script tag is removed from our website.

This technique doesn't break the same-origin policy because you are requesting **JavaScript** from another server, not JSON data. Requesting JavaScript from another domain is an integral part of the modern web and we do it all the time (e.g. loading jQuery from Google's CDN). In the extended anthrax metaphor from above, think of requesting JavaScript as a government official ordering a coffee - it **could** have anthrax in it, but it's so much less likely than a letter mailed to them with covered in creepy handwriting.

##### Disabling CORS
Some APIs have opted out of the same-origin policy by disabling CORS in their headers. This is a newish protocol and we cannot force any API to use it: it has to be done server-side. Unfortunately the TTC API doesn't use CORS.

##### What if that still doesn't work?
Sometimes you can't get data from an API even when you request JSONP. 
```bash
browser
{\__/}
( â€¢ . â€¢)
/ > âœ‰ï¸  can i have the data?

server
{\__/}
( 0 - 0)
ğŸ’¾ <\  i do not know you
```

In that case, you can try using a _proxy server_.

```bash
browser
{\__/}
( â€¢ . â€¢)
/ > âœ‰ï¸ can i have the data?

proxy
{\__/}
( â€¢ - *)
/ >  lemme see your request?

proxy
{\__/}
( U - U)
/ >  âœ‰ï¸ can i have the data?

server
{\__/}
( â€¢ - â€¢)
/ > ğŸ’¾ here u go pal

```
A proxy server is a go-between that can speak both to the browser that's requesting data and the server from which the browser is requesting data.

```bash
proxy
{\__/}
( â€¢ - â€¢)
/ > ğŸ’¾ here u go pal

browser
{\__/}
( u . u)
/> ğŸ’¾ <\ thank u
```

Browser-to-server communication is sometimes blocked via CORS but server-to-server communication is more open. We have a proxy server with great documentation right [here](https://github.com/hackeryou/json-proxy) for situations like that!

### Let's fix our error
Let's change the `dataType` in the AJAX request in `my-first-ajax-request.html` from `json` to `jsonp`.

```js
$.ajax('http://myttc.ca/finch_station.json',{
  method: 'GET',
  dataType: 'jsonp'
}).then(function() {
  console.log('It worked!');
});
```

You should see `It worked!` in the console. But where's the data? We can see it in the 'Network' tab, but we can't use it in our JavaScript yet. 
![Successful AJAX request in the Network tab of Firefox](https://hychalknotes.s3.amazonaws.com/successful-ajax-request-in-network-tab.png)

Remember the `.then()` method?

The `.ajax()` method retrieves the information and upon the completion of the request, [the docs](https://api.jquery.com/deferred.then/) tell us to pass it into the `.then()` method that handles our next steps.

The `.then()` method has three parameters: 
1. what to do when the request is successful  (required)
1. what to do when there is an error (optional)
1. what to do while the request is in progress (optional)

We will only be using the required parameter right now.

[The docs](https://api.jquery.com/deferred.then/) say that this first parameter is expected to be a function, so let's add one:
```js
$.ajax('http://myttc.ca/finch_station.json', {
  method: 'GET',
  dataType: 'jsonp'
}).then(function() { });

// this is the same as:
// $.ajax('http://myttc.ca/finch_station.json', {
//   method: 'GET',
//   dataType: 'jsonp'
// }).then(resultsFunction());

// const resultsFunction(){
//   // do some stuff
// }
```

This is the function that will run when the request is successful. We can expect to have some JSON data from the API if the request is successful, so we'll pass that data as an argument called `result`:

```js
$.ajax('http://myttc.ca/finch_station.json', {
  method: 'GET',
  dataType: 'jsonp'
}).then(function(result) { });
```

When a function calls another function like this, we say that second one is the _callback function_. We've previously seen callback functions in event handlers:

```js
$('h1').on('click', function(){
  // here is the content of the callback function
})
```

Let's make our callback function do something! Let's log the data we got back from the API:
```js
$.ajax('http://myttc.ca/finch_station.json', {
  method: 'GET',
  dataType: 'jsonp'
}).then(function(result) {
  console.log('It worked! : ', result);
});
```

You should see our `It worked!` success message as well as an object containing _payload_ (another way of saying "the result of an API call") in the console.

### Working with JSON data

Once we can see our payload in the console, clicking on the little arrow next to it will open up the object for inspection. jQuery has _parsed_ (read and converted) the JSON into a JavaScript object so we can work with the returned data in a familiar way. 

We can use the parameter name we created (`result`) to refer to the object and access entries on it using dot notation:

* `result.lat` gives the latitude of the stop. 
* `result.vehicles` gives an array of all the vehicles near the stop.

We can do all the usual JavaScript and jQuery things with the data, like store the values in a variable:

```js
let closestVehicle = result.vehicles[0].distance;
```

Or update the DOM:

```js
$("p.distance").html(closestVehicle + "m");
```

#### Exercise: Working with `$.ajax()`

Get some practice debugging and working with `$.ajax()` in <a href="https://hychalknotes.s3.amazonaws.com/ajax-practice.html" class="exercise" download>**ajax-practice.html**</a>.<br> Solution is <a href="https://hychalknotes.s3.amazonaws.com/ajax-practice-answer.html" download>here</a>.

### Debugging AJAX requests

1. Open up your dev tools

2. Click on the 'Network' tab

3. Click the filter icon to choose which requests show up in this panel. You'll notice stylesheets, scripts, and images also show up here. Choose XHR to limit the view to AJAX requests only.

Chrome

![network filter on chrome](https://hychalknotes.s3.amazonaws.com/network-filter-chrome.png)


Firefox 

![network filter on Firefox](https://hychalknotes.s3.amazonaws.com/network-filter-firefox.png)

4. Refresh the page to start capturing requests in the Network panel.

5. Clicking on a request will take you to a panel where you can see the response header, response/body, etc.

Using the information here will help tremendously in debugging AJAX requests. If you don't see your request at all, check for things like syntax errors. If the request was made but the result wasn't as expected, have a look at the headers and body of the response.